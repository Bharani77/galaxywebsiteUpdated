(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[217],{1849:(e,s,t)=>{Promise.resolve().then(t.bind(t,6648))},6046:(e,s,t)=>{"use strict";var n=t(6658);t.o(n,"useRouter")&&t.d(s,{useRouter:function(){return n.useRouter}}),t.o(n,"useSearchParams")&&t.d(s,{useSearchParams:function(){return n.useSearchParams}})},6648:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>l});var n=t(5155),o=t(2115),r=t(6046);let i=(0,t(5974).UU)("https://sarsafeqetopciqjhzrt.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhcnNhZmVxZXRvcGNpcWpoenJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIzNTAwOTEsImV4cCI6MjA0NzkyNjA5MX0.cvIbQn7UbCrvjDVzA4-bB-UCsHM9gp9i1uVFWtPlH9c"),a={SESSION_TOKEN:"sessionToken",USER_ID:"userId",USERNAME:"username",SESSION_ID:"sessionId"};function l(){let[e,s]=(0,o.useState)(""),[t,l]=(0,o.useState)(""),[u,c]=(0,o.useState)(null),[d,g]=(0,o.useState)(!1),m=(0,r.useRouter)(),p=(0,o.useRef)(null),S=function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e3;c(e),setTimeout(()=>c(null),s)},f=()=>{let e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")+Date.now().toString(36)},h=()=>crypto.randomUUID(),b=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Your session has ended.";try{let e=sessionStorage.getItem(a.USER_ID);e&&(console.log("Terminating session for user:",e),Object.values(a).forEach(e=>{sessionStorage.removeItem(e),console.log("Removed key from session storage:",e)}),await i.from("users").update({session_token:null,active_session_id:null,last_logout:new Date().toISOString()}).eq("id",e))}catch(e){console.error("Error in session termination:",e)}finally{m.push("/"),S(e)}};(0,o.useEffect)(()=>((async()=>{let e=sessionStorage.getItem(a.USER_ID);e&&(p.current=i.channel("session_updates").on("broadcast",{event:"session_terminated"},async s=>{console.log("Received session termination broadcast for user:",s.userId),s.userId===parseInt(e)&&await b("Your session was ended due to a new login.")}).subscribe(e=>{console.log("Subscription status:",e)}))})(),()=>{p.current&&p.current.unsubscribe()}),[m]);let I=async n=>{if(n.preventDefault(),!d){g(!0);try{if(!e.trim()||!t.trim()){S("Please enter both username and password"),g(!1);return}if(!i)throw Error("Supabase client is not initialized.");let{data:n,error:o}=await i.from("users").select("*").eq("username",e).single();if(o||!n||n.password!==t){S("Invalid credentials"),g(!1);return}let r=f(),u=h();if(console.log("Creating new session for user:",n.id),console.log("New session ID:",u),n.active_session_id){console.log("Terminating existing session for user:",n.id);let{error:e}=await i.from("users").update({session_token:null,active_session_id:null,last_logout:new Date().toISOString()}).eq("id",n.id);if(e)throw Error("Failed to terminate existing session.");await i.channel("session_updates").send({type:"broadcast",event:"session_terminated",payload:{userId:n.id}}),console.log("Broadcasted session termination for user:",n.id),await new Promise(e=>setTimeout(e,1e3))}let{error:c}=await i.from("users").update({session_token:r,active_session_id:u,last_login:new Date().toISOString(),login_count:(n.login_count||0)+1}).eq("id",n.id);if(c)throw Error("Failed to create session.");sessionStorage.setItem(a.SESSION_TOKEN,r),sessionStorage.setItem(a.USER_ID,n.id.toString()),sessionStorage.setItem(a.USERNAME,e),sessionStorage.setItem(a.SESSION_ID,u),console.log("Session data saved in sessionStorage"),s(""),l(""),S("Sign in successful!"),m.push("/profile?username=".concat(encodeURIComponent(e)))}catch(e){e instanceof Error&&S("An error occurred during sign in. Please try again.")}finally{g(!1)}}};return(0,n.jsx)("div",{className:"min-h-screen bg-gradient-to-b from-gray-900 via-purple-900 to-violet-600 flex items-center justify-center p-4",children:(0,n.jsxs)("div",{className:"bg-gray-800/50 backdrop-blur-lg p-8 rounded-xl shadow-xl max-w-md w-full",children:[(0,n.jsx)("h1",{className:"text-3xl font-bold text-white text-center mb-8",children:"Galaxy KickLock SignIn"}),u&&(0,n.jsx)("div",{className:"mb-4 p-3 bg-blue-500/20 text-white rounded-lg text-center",children:u}),(0,n.jsxs)("form",{onSubmit:I,className:"space-y-6",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-white mb-2",children:"Username"}),(0,n.jsx)("input",{type:"text",value:e,onChange:e=>s(e.target.value),className:"w-full px-4 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter username",disabled:d})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-white mb-2",children:"Password"}),(0,n.jsx)("input",{type:"password",value:t,onChange:e=>l(e.target.value),className:"w-full px-4 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter password",disabled:d})]}),(0,n.jsx)("button",{type:"submit",className:"w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition duration-200 disabled:opacity-50",disabled:d,children:d?"Signing in...":"Sign In"})]})]})})}}},e=>{var s=s=>e(e.s=s);e.O(0,[736,441,517,358],()=>s(1849)),_N_E=e.O()}]);